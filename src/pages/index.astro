---
import Layout from "../layouts/Layout.astro";
import teams from "../data/teams.json";
import metros from "../data/metros.json";
import "../styles/global.css";

const siteTitle = "homegame.today";
const pageTitle = "Is there a home game today?";
const description =
  "Pick your team to see if there's a home game today. MLB, NBA, NHL, and NFL — all in one place.";
const site = Astro.site;
const ogImage = site ? new URL(`/og/site.png`, site).toString() : `/og/site.png`;

const sportOrder = ["mlb", "nba", "nhl", "nfl"] as const;
const sportLabels: Record<string, string> = {
  mlb: "MLB",
  nba: "NBA",
  nhl: "NHL",
  nfl: "NFL",
};

// Build metro → teams map, sorted by sport order then name
const metroMap = new Map<string, typeof teams>();
for (const team of teams) {
  const metroId = (team as any).metro || "other";
  if (!metroMap.has(metroId)) metroMap.set(metroId, []);
  metroMap.get(metroId)!.push(team);
}

// Sort teams within each metro: by sport order, then alphabetically
for (const [, metroTeams] of metroMap) {
  metroTeams.sort((a: any, b: any) => {
    const sa = sportOrder.indexOf(a.sport as any);
    const sb = sportOrder.indexOf(b.sport as any);
    if (sa !== sb) return sa - sb;
    return a.name.localeCompare(b.name);
  });
}

// Sort metros alphabetically by display name
const metroLookup = new Map(metros.map((m: any) => [m.id, m]));
const sortedMetroIds = Array.from(metroMap.keys()).sort((a, b) => {
  const ma = metroLookup.get(a);
  const mb = metroLookup.get(b);
  return (ma?.name || a).localeCompare(mb?.name || b);
});
---

<Layout title={`${pageTitle} | ${siteTitle}`} description={description} ogImage={ogImage}>
  <header class="grid gap-3 justify-items-center text-center pt-12 px-6 pb-5">
    <h1 class="m-0 font-extrabold tracking-tight text-[clamp(2rem,6vw,3rem)]">homegame.today</h1>
    <p class="m-0 opacity-80 text-[clamp(1rem,2.5vw,1.125rem)]">
      Select your team to see if there's a home game today.
    </p>
    <div class="flex flex-col items-center gap-3 w-full max-w-lg mt-2">
      <label class="block w-full">
        <span class="sr-only">Search teams</span>
        <input
          id="team-search"
          type="search"
          placeholder="Search teams…"
          autocomplete="off"
          inputmode="search"
          class="w-full px-4 py-3 rounded-xl border border-gray-200 bg-white text-base outline-none shadow-inner focus:border-slate-300 focus:ring-2 focus:ring-blue-500/15"
        />
      </label>
      <nav aria-label="Filter by sport" class="flex gap-1.5 flex-wrap justify-center">
        <button
          data-sport-filter="all"
          class="sport-tab px-3 py-1.5 text-sm font-semibold rounded-lg border border-gray-200 bg-gray-900 text-white cursor-pointer"
          aria-pressed="true">All</button
        >
        {
          sportOrder.map((sport) => (
            <button
              data-sport-filter={sport}
              class="sport-tab px-3 py-1.5 text-sm font-semibold rounded-lg border border-gray-200 bg-white text-gray-700 cursor-pointer hover:bg-gray-50"
              aria-pressed="false"
            >
              {sportLabels[sport]}
            </button>
          ))
        }
      </nav>
    </div>
  </header>

  <div id="metro-list" class="px-6 pb-8">
    {
      sortedMetroIds.map((metroId) => {
        const metro = metroLookup.get(metroId);
        const metroTeams = metroMap.get(metroId) || [];
        const metroName = metro?.name || metroId;
        return (
          <section data-metro={metroId} class="mb-6">
            <h2 class="text-sm font-bold uppercase tracking-widest text-gray-400 mb-2 px-1">
              {metroName}
            </h2>
            <ul class="grid sm:grid-cols-2 lg:grid-cols-3 gap-2 list-none m-0 p-0">
              {metroTeams.map((team: any) => (
                <li
                  class="list-none"
                  data-team={team.name.toLowerCase()}
                  data-sport={team.sport}
                  data-metro={metroId}
                >
                  <a
                    aria-label={`Go to ${team.name} page`}
                    class="flex items-center gap-3 px-4 py-3 no-underline bg-white border border-gray-200 rounded-xl duration-150 ease-out hover:-translate-y-px hover:bg-gray-50 hover:border-gray-300"
                    href={
                      import.meta.env.DEV ? `/${team.slug}` : `https://${team.slug}.homegame.today`
                    }
                  >
                    <span
                      class="w-3 h-3 rounded-full shrink-0 shadow-[inset_0_0_0_1px_rgba(0,0,0,0.08)]"
                      style={`background:${team.colors?.[0] ?? "#e5e7eb"}`}
                    />
                    <span class="font-semibold tracking-tight">{team.name}</span>
                    <span class="ml-auto text-xs font-medium text-gray-400 uppercase">
                      {sportLabels[team.sport as string] || team.sport}
                    </span>
                  </a>
                </li>
              ))}
            </ul>
          </section>
        );
      })
    }
  </div>
  <p id="no-results" class="text-center px-6 pb-12 opacity-80" hidden>
    No teams match your search.
  </p>

  <script>
    const searchInput = document.getElementById("team-search") as HTMLInputElement | null;
    const metroList = document.getElementById("metro-list") as HTMLElement | null;
    const sections = Array.from(
      metroList?.querySelectorAll("section[data-metro]") ?? []
    ) as HTMLElement[];
    const items = Array.from(metroList?.querySelectorAll("li[data-team]") ?? []) as HTMLElement[];
    const emptyState = document.getElementById("no-results") as HTMLElement | null;
    const sportTabs = Array.from(
      document.querySelectorAll("[data-sport-filter]")
    ) as HTMLButtonElement[];

    let activeSport = "all";

    function applyFilters(): void {
      const query = (searchInput?.value || "").toLowerCase();
      let totalVisible = 0;

      for (const item of items) {
        const name = item.dataset.team || "";
        const sport = item.dataset.sport || "";
        const matchesSport = activeSport === "all" || sport === activeSport;
        const matchesSearch = !query || name.includes(query);
        const show = matchesSport && matchesSearch;
        item.hidden = !show;
        if (show) totalVisible++;
      }

      // Hide metro sections with no visible teams
      for (const section of sections) {
        const visibleTeams = section.querySelectorAll("li[data-team]:not([hidden])");
        (section as HTMLElement).hidden = visibleTeams.length === 0;
      }

      if (emptyState) emptyState.hidden = totalVisible !== 0;
    }

    // Sport filter tabs
    for (const tab of sportTabs) {
      tab.addEventListener("click", () => {
        activeSport = tab.dataset.sportFilter || "all";
        for (const t of sportTabs) {
          const isActive = t === tab;
          t.setAttribute("aria-pressed", String(isActive));
          if (isActive) {
            t.classList.add("bg-gray-900", "text-white");
            t.classList.remove("bg-white", "text-gray-700");
          } else {
            t.classList.remove("bg-gray-900", "text-white");
            t.classList.add("bg-white", "text-gray-700");
          }
        }
        applyFilters();
      });
    }

    // Search
    if (searchInput) {
      searchInput.addEventListener("input", () => applyFilters());
    }

    document.addEventListener("DOMContentLoaded", () => applyFilters());
  </script>
</Layout>
